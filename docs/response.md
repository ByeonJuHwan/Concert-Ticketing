# 장애대응

콘서트 좌석 예약의 경우 부하테스트 결과 6,000명 이상의 부하가 몰릴시 장애로 이어집니다.

따라서 6,000명 이상의 부하가 발생했을시 어떻게 해결하고 대응해야하는지 가상 장애 대응을 진행해 보겠습니다.

## 장애 모니터링 및 알림

콘서트 좌석 예약 시스템에는 Grafana 를 사용하여 시스템을 지속적으로 모니터링을 진행하며, 이 모니터링 시스템에서 이상 현상을 탐지하면,
즉각적으로 인지하기 위해서 Slack 으로 알림을 발송하도록 처리했습니다.

![](https://velog.velcdn.com/images/asdcz11/post/585bd365-c4b6-4fb2-a15b-b2b65e749f35/image.png)

대기열 이라는 특성상 급격하게 부하가 몰릴수 있기 때문에 CPU 사용량이 급격히 증가합니다.
따라서 시스템의 CPU 허용량을 넘어서 장애로 발생되기 전에 사용량 80 % 가 된다면 담당자가 인지하고 대응할수 있도록 했습니다.

## 원인 분석 및 조치

리소스 사용량에 대한 이슈 이므로 리소스 사용에 대한 대응을 해야합니다.

리소스 이슈 대응 방안은 아래와 같습니다.

**원인분석**

- 데이터베이스 연결 풀이 포화 상태임을 확인
- 애플리케이션 서버의 스레드 풀도 거의 소진된 상태 확인
- CPU 사용량 90% 이상 도달 확인
- 평균 응답시간 3초 이상 증가 확인

**조치방법**

1. 서버 스케일 업
   - 단일 서버의 처리 능력 향상
   - CPU, 메모리등 하드웨어 부분 업그레이드
2. 애플리케이션 서버 스케일 아웃
   - 새로운 서버 인스턴스를 추가하여 부하를 분산
   - 로드 밸런서를 통한 트래픽 분산 필요
3. 코드 개선
    - 자주 조회되는 콘서트 정보에 Redis 캐시 적용
      - 예상 효과 : DB 쿼리 감소, 응답 시간 단축
    - DB 인덱스 최적화
      - 예상 효과 : 쿼리 실행 시간 단축, DB 부하 감소
    - N+1 쿼리 문제 확인 및 수정
      - 예상 효과 : 중복 쿼리 감소, 전체 쿼리 실행 시간 단축

이때 대응 방안으로 쓰레드풀의 개수를 늘리는 방법도 고민 했었지만, 만약 쓰레드 풀을 늘리면 제가 바로 해결될까요?

HikariCP의 기본 스레드 개수는 5개에 `maximumPoolSize` 는 기본 값이 10개 입니다.
만약 `maximumPoolSize` 를 20개로 늘리면 1개의 서버당 스레드가 10개씩 더 생성이되고 스케일 아웃으로 인해 서버가 100대가 떠있다면 1000개의
스레드가 생성됩니다. 이 경우 DB 에 부하가 갈 수 있기에 역으로 DB 에 장애가 발생할 가능성이 생깁니다.


**현재 장애 상황 대응**

1. 즉각 조치 : 스케일 아웃
   - Kubernetes 클러스터에 3개의 새로운 파드 즉시 추가
   - 이유 : 빠른 대응 가능, 현재 CPU 부하 즉시 분산 가능
2. 단기 조치 : 코드 개선
   - Redis 캐시 적용 및 DB 인덱스 최적화 진행
   - 이유 : 추가 리소스 없이 성능 개선 가능, 중장기적인 효과
3. 중장기 계획 : 스케일 업 고려
   - 트래픽 증가 추세를 모니터링 하며 필요시 서버 사양 업그레이드
   - 이유 : 지속적인 성능 향상 필요시 효과적

## 안정화 및 개선 계획

CPU 사용량이 정상적으로 돌아올 경우 Grafana 에서 감지하고 정상적으로 돌아왔다고 알림을 보내줍니다.

해결된 알림을 바탕으로 전 구성원이 장애해결에 대해서 인지 할 수 있고, 이를 바탕으로 장애 발생시 어떻게 대처할 것 인지 확립이 가능합니다.

![](https://velog.velcdn.com/images/asdcz11/post/9459a990-ccb1-4ada-a948-d57e6d72ba17/image.png)

**개선 계획**

1. 성능 모니터링 강화
   - 알림 임계값 조정 : 80 % 로 설정시 이미 성능이 느려진 이후 일 수 있으므로 70 % 부터 조기 경보 설정
2. 부하 테스트 주기적 실시
   - 위 개선사항을 적용 후 최대 10,000명 동시 접속 시나리오로 월 1회 테스트
   - 결과 문석 및 시스템 최적화에 반영하여 지속적으로 개선사항을 업데이트 합니다
3. 장애 대응 훈련
   - 분기별 모의 장애 상황 대응 훈련 실시하여 장애 발생에 적합한 프로세스를 확립합니다
   - 대응 메뉴얼 지속적 업데이트 및 개선

